---
- name: Check whether Kubernetes has already been initialized.
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubernetes_init_stat

- name: Run kubeadm init
  shell: >-
    kubeadm init
    --pod-network-cidr={{ pod_network }}
    --token {{ kubeadm_token }}
    --kubernetes-version v{{ kubernetes_version }}
    --apiserver-cert-extra-sans={{ inventory_hostname }}
  when: not kubernetes_init_stat.stat.exists

- name: Remove the Kubernetes configuration directory
  file:
    path=~/.kube
    state=absent
  become: false

- name: Create the Kubernetes configuration directory
  file:
    path=~/.kube
    state=directory
  become: false

- name: Copy the Kubernetes configuration files
  shell: |
    sudo cp -i /etc/kubernetes/admin.conf ~/.kube/config
  become: false

- name: Fix permissions on the Kubernetes configuration file
  shell: |
    sudo chown $(id -u):$(id -g) ~/.kube/config
  become: false

- name: Copy the Kubernetes configuration file
  fetch:
    src: ~/.kube/config
    dest: kubeconfig
  become: false

- name: Configure networking
  shell: >-
    kubectl
       apply
      -f https://raw.githubusercontent.com/coreos/flannel/{{ flannel_version }}/Documentation/kube-flannel.yml
  become: false

  # Only taint the master node if no worker nodes exist.
- name: Tainting the master node
  shell: kubectl taint nodes --all node-role.kubernetes.io/master-
  become: false
  when: "'device-farm-workers' not in groups or groups['device-farm-workers'] | length == 0"

- name: Configure Helm service account YAML configuration
  copy:
    content: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: helm
        namespace: kube-system
      ---
      apiVersion: rbac.authorization.k8s.io/v1beta1
      kind: ClusterRoleBinding
      metadata:
        name: helm
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
        - kind: ServiceAccount
          name: helm
          namespace: kube-system
    dest: ~/helm-service-account.yml
  become: false
  when: not helm_exists.stat.exists

- name: Delete Helm service accounts
  command: kubectl delete --ignore-not-found=true -f ~/helm-service-account.yml
  become: false
  when: not helm_exists.stat.exists

- name: Create Helm service accounts
  command: kubectl create -f ~/helm-service-account.yml
  become: false
  when: not helm_exists.stat.exists

- name: Initializing Helm
  command: helm init --service-account helm
  become: false

- name: Waiting for Helm to become available
  command: kubectl rollout status -w deployment/tiller-deploy --namespace=kube-system
  become: false
